<!-- src/templates/index.html -->
<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Librarian ‚Äî RAG + TTS/STT</title>
  <style>
    :root {
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --fg:#e5e7eb; --accent:#22d3ee; --accent-2:#38bdf8;
      --bubble-user:#1f2937; --bubble-bot:#0b1220; --border:#1f2937;
    }
    * { box-sizing: border-box; }
    body { margin:0; background: radial-gradient(1200px 600px at 20% -10%, #0b1220, #0f172a 60%), linear-gradient(180deg, #0f172a 0, #0b1020 100%); color: var(--fg); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    .container { max-width: 980px; margin: 0 auto; padding: 24px; }
    .header { display:flex; align-items:center; gap:12px; padding: 8px 0 20px; }
    .brand { font-weight:700; letter-spacing:0.2px; font-size: 22px; }
    .pill { border:1px solid var(--border); background: rgba(255,255,255,0.02); color: var(--muted); padding:6px 10px; border-radius:999px; font-size:12px; }
    .chat { background: rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:16px; min-height: 60vh; padding:20px; display:flex; flex-direction:column; gap:14px; }
    .msg { display:flex; gap:10px; align-items:flex-start; }
    .avatar { flex:0 0 36px; height:36px; width:36px; border-radius:8px; display:grid; place-items:center; font-size:18px; background: linear-gradient(135deg, #0ea5e9, #22d3ee); }
    .avatar.user { background: linear-gradient(135deg, #6366f1, #a78bfa); }
    .bubble { padding:12px 14px; border-radius:12px; border:1px solid var(--border); max-width: 75%; line-height: 1.55; white-space:pre-wrap; }
    .bubble.user { background: var(--bubble-user); }
    .bubble.bot { background: var(--bubble-bot); }
    .sources { margin-top:6px; font-size:12px; color: var(--muted); border-left:3px solid var(--accent-2); padding-left:10px; }
    .composer { display:flex; gap:10px; margin-top: 14px; }
    .input { flex:1; background: var(--panel); border:1px solid var(--border); color: var(--fg); padding:12px 14px; border-radius:12px; resize:vertical; min-height:48px; max-height: 180px; }
    .btn { border:1px solid var(--border); background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); color: var(--fg); padding:10px 12px; border-radius:12px; cursor:pointer; display:inline-flex; align-items:center; gap:8px; }
    .btn:hover { border-color:#334155; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .switch { display:inline-flex; align-items:center; gap:8px; color:var(--muted); font-size:13px; }
    .switch input { width: 18px; height:18px; }
    .footer { margin-top: 10px; color:var(--muted); font-size:12px; text-align:center; }
    .typing { color:var(--muted); font-style:italic; }
    .divider { height:1px; background:linear-gradient(90deg, transparent, #1e293b, transparent); margin: 12px 0; }
    .hidden { display:none; }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="avatar">üìö</div>
    <div class="brand">Smart Librarian</div>
    <span class="pill">RAG + Tool + TTS/STT</span>
    <span class="pill">FastAPI</span>
  </div>

  <div id="chat" class="chat"></div>

  <div class="composer">
    <textarea id="input" class="input" placeholder="Scrie sau apasƒÉ üéôÔ∏è pentru voce..."></textarea>
    <div class="row">
      <button id="micBtn" class="btn" title="Voice input (STT)">üéôÔ∏è<span class="lbl">Start</span></button>
      <button id="speakToggle" class="btn" title="Cite»ôte automat rƒÉspunsurile (TTS)">üîä Auto</button>
      <button id="sendBtn" class="btn" title="Trimite">‚û§ Trimite</button>
      <button id="clearBtn" class="btn" title="»òterge conversa»õia">üóëÔ∏è</button>
    </div>
  </div>
<!-- TTS controls -->
<div class="row" style="margin-top:8px">
  <label class="switch">Voce:
    <select id="voiceSelect"></select>
  </label>
  <label class="switch">VitezƒÉ:
    <input id="rate" type="range" min="0.7" max="1.3" step="0.05" value="1.0">
  </label>
  <label class="switch">Pitch:
    <input id="pitch" type="range" min="0.8" max="1.2" step="0.05" value="1.0">
  </label>
</div>

  <div class="footer">Folose»ôte microfonul (dacƒÉ e suportat de browser). RƒÉspunsurile pot fi citite cu TTS. </div>
</div>

<script>
  // ====== State ======
  const chatEl = document.getElementById('chat');
  const inputEl = document.getElementById('input');
  const sendBtn = document.getElementById('sendBtn');
  const clearBtn = document.getElementById('clearBtn');
  const micBtn = document.getElementById('micBtn');
  const speakToggle = document.getElementById('speakToggle');

    // TTS controls
  const voiceSelect = document.getElementById('voiceSelect');
  const rateEl = document.getElementById('rate');
  const pitchEl = document.getElementById('pitch');


  let autoSpeak = false;
  let recognizing = false;
  let recognition = null;

  // ====== Helpers ======
  function el(tag, cls, text) {
    const e = document.createElement(tag);
    if (cls) e.className = cls;
    if (text !== undefined) e.textContent = text;
    return e;
  }

  function addMessage(role, text, sources=null) {
    const row = el('div', 'msg');
    const av = el('div', 'avatar ' + (role==='user'?'user':''), role==='user'?'üôÇ':'ü§ñ');
    const bub = el('div', 'bubble ' + (role==='user'?'user':'bot'));
    bub.textContent = text;

    row.appendChild(av);
    row.appendChild(bub);

    if (role==='assistant' && sources && sources.length) {
      const src = el('div','sources');
      src.textContent = 'Sources: ' + sources.map(s => `${s.title}`).join(' ‚Ä¢ ');
      row.appendChild(el('div','avatar hidden')); // pad for alignment
      row.appendChild(src);
    }

    chatEl.appendChild(row);
    chatEl.scrollTop = chatEl.scrollHeight;

    // Speak if enabled
    if (role === 'assistant' && autoSpeak && 'speechSynthesis' in window) {
      speak(text);
    }
  }

  function setTyping(on) {
    let t = document.getElementById('typing');
    if (on) {
      if (!t) {
        t = el('div','typing'); t.id='typing'; t.textContent='Asistentul scrie...';
        chatEl.appendChild(t);
      }
    } else {
      if (t) t.remove();
    }
    chatEl.scrollTop = chatEl.scrollHeight;
  }

function speak(text) {
  if (!('speechSynthesis' in window)) return;
  const synth = window.speechSynthesis;
  synth.cancel();

  const chosenName = voiceSelect?.value || localStorage.getItem('voiceName');
  const voices = synth.getVoices();
  let voice = voices.find(v => v.name === chosenName);
  if (!voice) {
    voice = voices.find(v => (v.lang||'').toLowerCase().startsWith('ro')) || voices[0];
  }

  const rate = parseFloat(rateEl?.value || '1.0');
  const pitch = parseFloat(pitchEl?.value || '1.0');

  const queue = splitIntoChunks(text, 180);
  const speakNext = () => {
    if (!queue.length) return;
    const chunk = queue.shift();
    const u = new SpeechSynthesisUtterance(chunk);
    u.voice = voice || null;
    u.lang = (voice && voice.lang) ? voice.lang : 'ro-RO';
    u.rate = rate;    // recomandat: 0.9‚Äì1.05
    u.pitch = pitch;  // recomandat: 0.95‚Äì1.05
    u.onend = () => speakNext();
    synth.speak(u);
  };
  speakNext();
}


  function initSTT() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) return null;
    const r = new SR();
    r.lang = 'ro-RO'; // po»õi schimba/en-US etc.
    r.interimResults = false;
    r.maxAlternatives = 1;
    r.onresult = (ev) => {
      const text = ev.results[0][0].transcript;
      inputEl.value = text;
    };
    r.onend = () => {
      recognizing = false;
      micBtn.querySelector('.lbl').textContent = 'Start';
      micBtn.disabled = false;
    };
    r.onerror = () => {
      recognizing = false;
      micBtn.querySelector('.lbl').textContent = 'Start';
      micBtn.disabled = false;
    };
    return r;
  }

  recognition = initSTT();

  // --- Voice list handling (prefer ro-RO) ---
function populateVoices() {
  if (!('speechSynthesis' in window)) return;
  const all = window.speechSynthesis.getVoices() || [];
  const sorted = all.slice().sort((a,b) => {
    const ar = (a.lang||'').toLowerCase().startsWith('ro') ? -1 : 1;
    const br = (b.lang||'').toLowerCase().startsWith('ro') ? -1 : 1;
    if (ar !== br) return ar - br;
    return (a.name || '').localeCompare(b.name || '');
  });
  voiceSelect.innerHTML = '';
  sorted.forEach(v => {
    const opt = document.createElement('option');
    opt.value = v.name;
    opt.textContent = `${v.name} ‚Äî ${v.lang}`;
    voiceSelect.appendChild(opt);
  });
  const saved = localStorage.getItem('voiceName');
  const preferRo = sorted.find(v => (v.lang||'').toLowerCase().startsWith('ro'));
  const fallback = sorted[0];
  const target = sorted.find(v => v.name === saved) || preferRo || fallback;
  if (target) {
    voiceSelect.value = target.name;
    localStorage.setItem('voiceName', target.name);
  }
}
if ('speechSynthesis' in window) {
  populateVoices();
  window.speechSynthesis.onvoiceschanged = populateVoices;
}
voiceSelect?.addEventListener('change', () => {
  localStorage.setItem('voiceName', voiceSelect.value);
});

// --- Split long text into natural chunks (sentences) ---
function splitIntoChunks(text, maxLen = 180) {
  const parts = [];
  const sentences = text
    .replace(/\s+/g,' ')
    .split(/([\.!\?;:])\s+/)
    .reduce((acc, cur) => {
      if (!acc.length) { acc.push(''); }
      if (/^[\.!\?;:]$/.test(cur)) {
        acc[acc.length-1] += cur;
      } else if (cur.trim()) {
        acc.push(cur.trim());
      }
      return acc;
    }, []).filter(Boolean);

  let buf = '';
  for (const s of sentences) {
    if ((buf + ' ' + s).trim().length <= maxLen) {
      buf = (buf ? buf + ' ' : '') + s;
    } else {
      if (buf) parts.push(buf);
      if (s.length > maxLen) {
        const chunks = s.split(/, /);
        let b = '';
        for (const c of chunks) {
          if ((b + ', ' + c).length <= maxLen) b = (b ? b + ', ' : '') + c;
          else { if (b) parts.push(b); b = c; }
        }
        if (b) parts.push(b);
        buf = '';
      } else {
        buf = s;
      }
    }
  }
  if (buf) parts.push(buf);
  return parts;
}


  // ====== Events ======
  sendBtn.onclick = async () => {
    const text = inputEl.value.trim();
    if (!text) return;
    addMessage('user', text);
    inputEl.value = '';

    setTyping(true);
    try {
      const res = await fetch('/api/chat', {
        method:'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({message: text})
      });
      setTyping(false);

      if (!res.ok) {
        const e = await res.json().catch(()=>({error:'Eroare la server'}));
        addMessage('assistant', `‚ö†Ô∏è ${e.error || 'Eroare'}`);
        return;
      }
      const data = await res.json();
      addMessage('assistant', data.answer, data.sources || []);
    } catch (err) {
      setTyping(false);
      addMessage('assistant', '‚ö†Ô∏è Nu am reu»ôit sƒÉ contactez serverul.');
    }
  };

  inputEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendBtn.click();
    }
  });

  clearBtn.onclick = () => {
    chatEl.innerHTML = '';
    window.speechSynthesis && window.speechSynthesis.cancel();
  };

  speakToggle.onclick = () => {
    autoSpeak = !autoSpeak;
    speakToggle.style.borderColor = autoSpeak ? 'var(--accent)' : 'var(--border)';
    speakToggle.style.color = autoSpeak ? 'white' : 'var(--fg)';
  };

  micBtn.onclick = () => {
    if (!recognition) {
      addMessage('assistant', 'üéôÔ∏è Browserul tƒÉu nu suportƒÉ Speech Recognition.');
      return;
    }
    if (!recognizing) {
      recognizing = true;
      micBtn.querySelector('.lbl').textContent = 'Stop';
      micBtn.disabled = true; // prevenim dublu-click
      try {
        recognition.start();
      } catch(e) {
        recognizing = false;
        micBtn.querySelector('.lbl').textContent = 'Start';
        micBtn.disabled = false;
      }
    }
  };
</script>
</body>
</html>
